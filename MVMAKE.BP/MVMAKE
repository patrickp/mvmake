SUBROUTINE MVMAKE(CMND)

PLATFORM=FIELD(CMND,' ',2)
MVTYPE=FIELD(CMND,' ',3)
PACKAGE.NAME=FIELD(CMND,' ',4)
PASSED.PACKAGE=PACKAGE.NAME
PACKAGE.PATH=FIELD(CMND,'',5)

IF PLATFORM = "" THEN
    PRINT "ENTER PLATFORM (LINUX OR WINDOWS): ":; INPUT PLATFORM
END

PLATFORM=OCONV(PLATFORM,"MCU")

BEGIN CASE
    CASE PLATFORM="WINDOWS"
        D3.PREFIX="dos"
        PLATFORM.DELIM="\"
    CASE PLATFORM="LINUX"
        D3.PREFIX="unix"
        PLATFORM.DELIM="/"
    CASE 1
        STOP "Invalid Platform ":PLATFORM
END CASE

IF MVTYPE="" THEN
    PRINT "ENTER MVTYPE (JBASE, QM, D3, UNIVERSE, UNIDATA) ":; INPUT MVTYPE
END

MVTYPE=OCONV(MVTYPE,"MCU")

BEGIN CASE
    CASE MVTYPE="JBASE"
    CASE MVTYPE="QM"
    CASE MVTYPE="D3"
    CASE MVTYPE="UNIVERSE"
    CASE MVTYPE="UNIDATA"
    CASE 1
        STOP "Invalid MVTYPE"
END CASE

*
OPEN "MD" TO FILE.MD ELSE
    OPEN "VOC" TO FILE.MD ELSE STOP "Could not find MD or VOC"
END

IF PACKAGE.NAME = "" THEN
    PRINT "Enter package name: ":; INPUT PACKAGE.NAME
END

PACKAGE.PATH = PACKAGE.NAME

IF PASSED.PACKAGE # "" AND PACKAGE.PATH="" THEN PACKAGE.PATH=PASSED.PACKAGE

IF PACKAGE.PATH = "" THEN
    PRINT "Enter path to package (":PACKAGE.PATH:") ":; INPUT TMP.INPUT
    IF TMP.INPUT # "" THEN PACKAGE.PATH=TMP.INPUT
END

MD.NAME = OCONV(PACKAGE.NAME,"MCU"):".BP"

READ ITEM.MD FROM FILE.MD, MD.NAME ELSE ITEM.MD=""
IF ITEM.MD # "" THEN STOP "MD Item aleady exists"

BEGIN CASE
    CASE MVTYPE="D3"
        * ON D3 WE NEED A PICK FILE FOR OUR ROOT
        EXECUTE "CREATE-FILE (DICT ":ITEM.MD:" 11"
        OPEN "DICT",ITEM.MD TO FILE.DICT ELSE STOP "COULD NOT OPEN DICT ":ITEM.MD
        MD.ITEM="Q"
        MD.ITEM<3>=D3.PREFIX:":":PACKAGE.PATH
        WRITE MD.ITEM ON FILE.DICT, "ROOT"
        ROOT.NAME=ITEM.MD:",ROOT"
    CASE 1
        MD.ITEM="F"
        MD.ITEM<3>=PACKAGE.PATH
        WRITE MD.ITEM ON FILE.MD, MD.NAME
        ROOT.NAME="DICT " :MD.NAME
END CASE

OPEN ROOT.NAME TO FILE.ROOT ELSE STOP "COULD NOT OPEN ":ROOT.NAME

READ PACKAGE.MV FROM FILE.ROOT, "PACKAGE.MV" ELSE STOP "NO PACKAGE.MV IN ROOT DIR OF PACKAGE"

NUM.ENTRIES=DCOUNT(PACKAGE.MV,@AM)

DEBUG

FOR L=1 TO NUM.ENTRIES
    ENTRY=PACKAGE.MV<L>
    COMMAND=OCONV(ENTRY<1,1>,"MCU")
    BEGIN CASE
        CASE COMMAND="DIRECTORY"; GOSUB build.directory
        CASE 1; CRT "INVALID COMMAND ":COMMAND
    END CASE
NEXT L

RETURN

build.directory: *

DIRECTORY.NAME=ENTRY<1,2>
DIRECTORY.DIR.NAME=ENTRY<1,3>
IF DIRECTORY.DIR.NAME="" THEN DIRECTORY.DIR.NAME=DIRECTORY.NAME

CRT "Mapping directory for ":DIRECTORY.NAME:" ":
BEGIN CASE
    CASE MVTYPE="D3"
    CASE MVTYPE="JBASE"; * NOTHING
        SUB.NAME=MD.NAME:",":DIRECTORY.NAME
    CASE MVTYPE="QM"
    CASE MVTYPE="UNIVERSE"
    CASE MVTYPE="UNIDATA"
END CASE

PRINT "(":SUB.NAME:") ":
OPEN SUB.NAME TO FILE.SUB.NAME ELSE
    STOP "Failed"
END
CLOSE FILE.SUB.NAME

RETURN

